<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âª∂ÈÅ≤Ë®òÊÜ∂Áéã - ËÅ∑ËÉΩÊ≤ªÁôÇÂ∏´ ÈÑ≠Âá±ÊñáË®≠Ë®à</title>
    <!-- React & Babel CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-12px); } 75% { transform: translateX(12px); } }
        .shake { animation: shake 0.2s cubic-bezier(.36,.07,.19,.97) both; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // È†êË®≠Ë©ûÂΩôÈ°åÂ∫´
        const INITIAL_WORD_SETS = [
            { category: "ÂÆ¢Âª≥ËàáÂ±ÖÂÆ∂", items: [
                { id: 'l1', name: 'ÈõªË¶ñ', icon: 'üì∫' }, { id: 'l2', name: 'Ê≤ôÁôº', icon: 'üõãÔ∏è' }, { id: 'l3', name: 'ÈÅôÊéßÂô®', icon: 'üïπÔ∏è' },
                { id: 'l4', name: 'ÈõªÈ¢®Êâá', icon: 'üåÄ' }, { id: 'l5', name: 'ÈõªË©±', icon: '‚òéÔ∏è' }, { id: 'l6', name: 'Ëå∂Âá†', icon: 'üçµ' },
                { id: 'l7', name: 'ÊôÇÈêò', icon: '‚è∞' }, { id: 'l8', name: 'Â†±Á¥ô', icon: 'üì∞' }, { id: 'l9', name: 'Ê™ØÁáà', icon: 'üí°' }, { id: 'l10', name: 'ÂÜ∑Ê∞£', icon: '‚ùÑÔ∏è' }
            ]},
            { category: "ÂªöÊàøËàáÈ£≤È£ü", items: [
                { id: 'k1', name: 'ÊπØÂåô', icon: 'ü•Ñ' }, { id: 'k2', name: 'Á≠∑Â≠ê', icon: 'ü•¢' }, { id: 'k3', name: 'Á¢óÂÖ¨', icon: 'ü•£' },
                { id: 'k4', name: 'ÂèâÂ≠ê', icon: 'üç¥' }, { id: 'k5', name: 'Á≥ñÊûú', icon: 'üç¨' }, { id: 'k6', name: 'Áõ§Â≠ê', icon: 'üçΩÔ∏è' },
                { id: 'k7', name: 'ÈõªÈçã', icon: 'üçö' }, { id: 'k8', name: 'ËèúÂàÄ', icon: 'üî™' }, { id: 'k9', name: 'Ê∞¥Â£∫', icon: 'üç∂' }, { id: 'k10', name: 'ÂÜ∞ÁÆ±', icon: 'üßä' }
            ]},
            { category: "Ëá•ÂÆ§Áî®ÂìÅ", items: [
                { id: 'b1', name: 'ÊûïÈ†≠', icon: 'üí§' }, { id: 'b2', name: 'Ê£âË¢´', icon: 'üõå' }, { id: 'b3', name: 'Â∫äÂ¢ä', icon: 'üõèÔ∏è' },
                { id: 'b4', name: 'Ë°£Ê´É', icon: 'üö™' }, { id: 'b5', name: 'Ê¢≥Â≠ê', icon: 'ü™Æ' }, { id: 'b6', name: 'Èè°Â≠ê', icon: 'ü™û' },
                { id: 'b7', name: 'Áù°Ë°£', icon: 'üëï' }, { id: 'b8', name: 'È¨ßÈêò', icon: 'üîî' }, { id: 'b9', name: 'ÊãñÈûã', icon: 'ü©¥' }, { id: 'b10', name: 'Á™óÁ∞æ', icon: 'üñºÔ∏è' }
            ]},
            { category: "Â§ñÂá∫ÂøÖÂÇô", items: [
                { id: 'o1', name: 'Èõ®ÂÇò', icon: 'üåÇ' }, { id: 'o2', name: 'Â∏ΩÂ≠ê', icon: 'üëí' }, { id: 'o3', name: 'Âè£ÁΩ©', icon: 'üò∑' },
                { id: 'o4', name: 'Èë∞Âåô', icon: 'üîë' }, { id: 'o5', name: 'Èå¢ÂåÖ', icon: 'üëõ' }, { id: 'o6', name: 'ÊâãÊ©ü', icon: 'üì±' },
                { id: 'o7', name: 'Ëá™Ë°åËªä', icon: 'üö≤' }, { id: 'o8', name: 'ÂÖ¨Ëªä', icon: 'üöå' }, { id: 'o9', name: 'ÊÇ†ÈÅäÂç°', icon: 'üí≥' }, { id: 'o10', name: 'ÊâãÈõªÁ≠í', icon: 'üî¶' }
            ]},
            { category: "‰ºëÈñíËààË∂£", items: [
                { id: 'h1', name: 'Ë±°Ê£ã', icon: '‚ôüÔ∏è' }, { id: 'h2', name: 'Êí≤ÂÖãÁâå', icon: 'üÉè' }, { id: 'h3', name: 'Êî∂Èü≥Ê©ü', icon: 'üìª' },
                { id: 'h4', name: 'ÁõÜÊ†Ω', icon: 'ü™¥' }, { id: 'h5', name: 'È≠öÁ´ø', icon: 'üé£' }, { id: 'h6', name: 'Áõ∏Ê©ü', icon: 'üì∑' },
                { id: 'h7', name: 'ÊØõÁ∑ö', icon: 'üß∂' }, { id: 'h8', name: 'ÈãºÁê¥', icon: 'üéπ' }, { id: 'h9', name: 'ÊØõÁ≠Ü', icon: 'üñåÔ∏è' }, { id: 'h10', name: 'ÊîæÂ§ßÈè°', icon: 'üîç' }
            ]}
        ];

        const STAGES = { START: 'START', MEMORIZE: 'MEMORIZE', DISTRACT: 'DISTRACT', RECALL: 'RECALL', RESULT: 'RESULT', HISTORY: 'HISTORY' };

        const COLORS = [
            { name: 'Á¥ÖËâ≤', color: '#ef4444' }, 
            { name: 'ËóçËâ≤', color: '#3b82f6' },
            { name: 'Á∂†Ëâ≤', color: '#22c55e' }, 
            { name: 'ÈªÉËâ≤', color: '#F2CD13' }, 
            { name: 'Á¥´Ëâ≤', color: '#a855f7' }, 
            { name: 'Ê©òËâ≤', color: '#f97316' },
            { name: 'Á≤âËâ≤', color: '#f472b6' }, 
            { name: 'Ê£ïËâ≤', color: '#92400e' },
            { name: 'ÈªëËâ≤', color: '#000000' }, 
            { name: 'ÁÅ∞Ëâ≤', color: '#94a3b8' }
        ];

        // Á∞°ÂñÆÁöÑÂúñÁ§∫ÁµÑ‰ª∂ (‰ª£Êõø Lucide Â∫´Âú® CDN ‰∏ãÁöÑ‰ΩøÁî®)
        const Icon = ({ name, size = 24, className = "" }) => {
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        function App() {
            const [stage, setStage] = useState(STAGES.START);
            const [wordLibrary, setWordLibrary] = useState(INITIAL_WORD_SETS);
            const [currentSet, setCurrentSet] = useState(null);
            const [targets, setTargets] = useState([]);
            const [options, setOptions] = useState([]);
            const [selections, setSelections] = useState([]);
            const [distractorTask, setDistractorTask] = useState({ word: '', color: '', isMatch: false });
            const [showPool, setShowPool] = useState(false);
            const [lastFeedback, setLastFeedback] = useState(null);
            const [score, setScore] = useState(0);
            const [viewingRecord, setViewingRecord] = useState(null);

            const distractorHistory = useRef({ matchCount: 0, mismatchCount: 0 });
            const [timerLeft, setTimerLeft] = useState(0);
            const [stats, setStats] = useState({
                startTime: 0, endTime: 0, distractorTotal: 0, distractorCorrect: 0, distractorWrong: 0, reactionTimes: [], lastActionTime: 0
            });

            const [practiceHistory, setPracticeHistory] = useState([]);
            const [newItem, setNewItem] = useState({ name: '', category: 'ÂÆ¢Âª≥ËàáÂ±ÖÂÆ∂' });

            const [config, setConfig] = useState({
                targetCount: 3, distractorMode: 'count', distractorTarget: 5, distractorDuration: 30, recallDistractorCount: 3, showIcons: true
            });

            useEffect(() => {
                // ÊØèÁï∂Áï´Èù¢Êõ¥Êñ∞ÊôÇÊ∏≤ÊüìÂúñÁ§∫
                if (window.lucide) window.lucide.createIcons();
            });

            const updateConfig = (key, val) => setConfig(prev => ({ ...prev, [key]: val }));

            const startGame = () => {
                const availableCategories = wordLibrary.filter(c => c.items.length >= config.targetCount);
                if (availableCategories.length === 0) return alert("È°åÂ∫´ÂÖßÂÆπ‰∏çË∂≥ÔºÅ");
                const randomSet = availableCategories[Math.floor(Math.random() * availableCategories.length)];
                const shuffledItems = [...randomSet.items].sort(() => 0.5 - Math.random());
                const targetItems = shuffledItems.slice(0, config.targetCount);
                setCurrentSet(randomSet);
                setTargets(targetItems);
                setSelections([]);
                setLastFeedback(null);
                setScore(0);
                setViewingRecord(null);
                setStats({ startTime: Date.now(), endTime: 0, distractorTotal: 0, distractorCorrect: 0, distractorWrong: 0, reactionTimes: [], lastActionTime: 0 });
                distractorHistory.current = { matchCount: 0, mismatchCount: 0 };
                setStage(STAGES.MEMORIZE);
            };

            const nextDistractor = useCallback(() => {
                const history = distractorHistory.current;
                let shouldMatch;
                if (history.matchCount > history.mismatchCount + 1) shouldMatch = false;
                else if (history.mismatchCount > history.matchCount + 1) shouldMatch = true;
                else shouldMatch = Math.random() > 0.5;
                const wordObj = COLORS[Math.floor(Math.random() * COLORS.length)];
                let colorObj;
                if (shouldMatch) {
                    colorObj = wordObj;
                    history.matchCount++;
                } else {
                    const otherColors = COLORS.filter(c => c.name !== wordObj.name);
                    colorObj = otherColors[Math.floor(Math.random() * otherColors.length)];
                    history.mismatchCount++;
                }
                setDistractorTask({ word: wordObj.name, color: colorObj.color, isMatch: shouldMatch });
                setStats(prev => ({ ...prev, lastActionTime: Date.now() }));
            }, []);

            const handleDistractorAnswer = (answer) => {
                const isCorrect = answer === distractorTask.isMatch;
                const now = Date.now();
                const reactionTime = now - stats.lastActionTime;
                setStats(prev => ({
                    ...prev,
                    distractorTotal: prev.distractorTotal + 1,
                    distractorCorrect: isCorrect ? prev.distractorCorrect + 1 : prev.distractorCorrect,
                    distractorWrong: !isCorrect ? prev.distractorWrong + 1 : prev.distractorWrong,
                    reactionTimes: [...prev.reactionTimes, reactionTime]
                }));
                if (isCorrect) {
                    setLastFeedback('correct');
                    const currentCorrect = stats.distractorCorrect + 1;
                    if (config.distractorMode === 'count' && currentCorrect >= config.distractorTarget) {
                        setTimeout(() => prepareRecall(), 400);
                    } else {
                        setTimeout(() => { setLastFeedback(null); nextDistractor(); }, 400);
                    }
                } else {
                    setLastFeedback('wrong');
                    setTimeout(() => { setLastFeedback(null); nextDistractor(); }, 600);
                }
            };

            useEffect(() => {
                let timer;
                if (stage === STAGES.DISTRACT && config.distractorMode === 'time') {
                    setTimerLeft(config.distractorDuration);
                    timer = setInterval(() => {
                        setTimerLeft(prev => {
                            if (prev <= 1) {
                                clearInterval(timer);
                                prepareRecall();
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(timer);
            }, [stage, config.distractorMode, config.distractorDuration]);

            const prepareRecall = () => {
                const distractorsPool = currentSet.items.filter(item => !targets.some(t => t.id === item.id));
                const selectedDistractors = [...distractorsPool].sort(() => 0.5 - Math.random()).slice(0, config.recallDistractorCount);
                const combined = [...targets, ...selectedDistractors].sort(() => 0.5 - Math.random());
                setOptions(combined);
                setStage(STAGES.RECALL);
            };

            const toggleSelection = (item) => {
                if (selections.find(s => s.id === item.id)) {
                    setSelections(selections.filter(s => s.id !== item.id));
                } else if (selections.length < targets.length) {
                    setSelections([...selections, item]);
                }
            };

            const finishGame = () => {
                const correctCount = selections.filter(s => targets.find(t => t.id === s.id)).length;
                const finalStats = { ...stats, endTime: Date.now(), finalScore: correctCount };
                setScore(correctCount);
                const record = {
                    id: Date.now(), date: new Date().toLocaleString(), config: { ...config },
                    targetItems: targets.map(t => ({ name: t.name, icon: t.icon, id: t.id })),
                    stats: finalStats,
                    selections: selections.map(s => ({ id: s.id, name: s.name, icon: s.icon, isCorrect: targets.some(t => t.id === s.id) }))
                };
                setPracticeHistory(prev => [record, ...prev]);
                setStage(STAGES.RESULT);
            };

            const showHistoryRecord = (record) => {
                setViewingRecord(record);
                setStage(STAGES.RESULT);
            };

            const handleDeleteItem = (categoryId, itemId) => {
                setWordLibrary(prev => prev.map(cat => (cat.category === categoryId ? { ...cat, items: cat.items.filter(item => item.id !== itemId) } : cat)));
            };

            const handleAddNewItem = (e) => {
                e.preventDefault();
                if (!newItem.name.trim()) return;
                const itemToAdd = { id: `custom-${Date.now()}`, name: newItem.name, icon: 'üì¶' };
                setWordLibrary(prev => prev.map(cat => cat.category === newItem.category ? { ...cat, items: [itemToAdd, ...cat.items] } : cat));
                setNewItem({ ...newItem, name: '' });
            };

            useEffect(() => { if (stage === STAGES.DISTRACT) nextDistractor(); }, [stage, nextDistractor]);

            const currentDisplay = viewingRecord ? {
                score: viewingRecord.stats.finalScore, targets: viewingRecord.targetItems, stats: viewingRecord.stats,
                config: viewingRecord.config, selections: viewingRecord.selections, date: viewingRecord.date
            } : {
                score: score, targets: targets, stats: stats, config: config, selections: selections, date: new Date().toLocaleString()
            };

            return (
                <div className="min-h-screen p-2 md:p-8">
                    <div className="max-w-3xl mx-auto bg-white rounded-[2.5rem] shadow-2xl overflow-hidden relative border border-slate-100">
                        {/* Header */}
                        <div className="bg-white border-b border-slate-100 p-6 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="p-2.5 bg-indigo-600 rounded-2xl text-white shadow-lg shadow-indigo-100">
                                    <Icon name="brain" />
                                </div>
                                <div>
                                    <h1 className="text-2xl font-black tracking-tight text-slate-900">Âª∂ÈÅ≤Ë®òÊÜ∂Áéã</h1>
                                    <p className="text-xs font-bold text-slate-400 uppercase tracking-widest">Cognitive Mastery Pro</p>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setStage(STAGES.HISTORY)} className="p-2.5 bg-slate-50 text-slate-500 hover:bg-indigo-50 hover:text-indigo-600 rounded-xl transition-all border border-slate-100">
                                    <Icon name="history" size={22} />
                                </button>
                                <button onClick={() => setShowPool(true)} className="flex items-center gap-2 bg-slate-50 text-slate-500 hover:bg-indigo-50 hover:text-indigo-600 px-4 py-2.5 rounded-xl text-sm font-bold transition-all border border-slate-100">
                                    <Icon name="package" size={20} /> ÁÆ°ÁêÜÈ°åÂ∫´
                                </button>
                            </div>
                        </div>

                        <div className="p-6 md:p-10">
                            {stage === STAGES.START && (
                                <div className="animate-in fade-in zoom-in duration-500">
                                    <div className="text-center mb-10">
                                        <div className="inline-block mb-4 px-4 py-1 bg-indigo-50 text-indigo-600 rounded-full text-sm font-black">DAILY TRAINING</div>
                                        <h2 className="text-4xl font-black text-slate-900 mb-2">Ê∫ñÂÇôÈñãÂßãË®ìÁ∑¥</h2>
                                        <p className="text-slate-400">ÂÆ¢Ë£ΩÂåñÊÇ®ÁöÑË™çÁü•ÊåëÊà∞Ê®°Âºè</p>
                                    </div>
                                    <div className="space-y-4 mb-10 max-w-xl mx-auto">
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="bg-slate-50/50 p-6 rounded-[2.5rem] border-2 border-slate-100 flex flex-col items-center">
                                                <div className="flex items-center gap-2 mb-4 text-indigo-500"><Icon name="target" size={20} /><span className="text-sm font-black text-slate-500">Áâ©ÂìÅË®òÊÜ∂</span></div>
                                                <div className="flex items-center gap-5">
                                                    <button onClick={() => updateConfig('targetCount', Math.max(1, config.targetCount - 1))} className="w-10 h-10 rounded-2xl bg-white border border-slate-200 flex items-center justify-center text-slate-400 shadow-sm active:scale-90"><Icon name="minus" size={18} /></button>
                                                    <span className="text-xl font-black min-w-[32px] text-center">{config.targetCount}</span>
                                                    <button onClick={() => updateConfig('targetCount', Math.min(10, config.targetCount + 1))} className="w-10 h-10 rounded-2xl bg-white border border-slate-200 flex items-center justify-center text-slate-400 shadow-sm active:scale-90"><Icon name="plus" size={18} /></button>
                                                </div>
                                            </div>
                                            <div className="bg-slate-50/50 p-6 rounded-[2.5rem] border-2 border-slate-100 flex flex-col items-center">
                                                <div className="flex items-center gap-2 mb-4 text-amber-500"><Icon name="layers" size={20} /><span className="text-sm font-black text-slate-500">ÂõûÊÜ∂Ê∑∑Ê∑Ü</span></div>
                                                <div className="flex items-center gap-5">
                                                    <button onClick={() => updateConfig('recallDistractorCount', Math.max(0, config.recallDistractorCount - 1))} className="w-10 h-10 rounded-2xl bg-white border border-slate-200 flex items-center justify-center text-slate-400 shadow-sm active:scale-90"><Icon name="minus" size={18} /></button>
                                                    <span className="text-xl font-black min-w-[32px] text-center">{config.recallDistractorCount}</span>
                                                    <button onClick={() => updateConfig('recallDistractorCount', Math.min(15, config.recallDistractorCount + 1))} className="w-10 h-10 rounded-2xl bg-white border border-slate-200 flex items-center justify-center text-slate-400 shadow-sm active:scale-90"><Icon name="plus" size={18} /></button>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="bg-slate-50/50 p-6 rounded-[2rem] border-2 border-slate-100">
                                            <div className="flex justify-between items-center mb-5">
                                                <div className="flex items-center gap-2"><Icon name="zap" size={18} className="text-indigo-600" /><span className="text-lg font-black text-slate-700">‰ªªÂãôÂàáÊèõÊ®°Âºè</span></div>
                                                <div className="flex bg-slate-200 p-1 rounded-xl">
                                                    <button onClick={() => updateConfig('distractorMode', 'count')} className={`px-4 py-1.5 rounded-lg font-bold text-xs transition-all ${config.distractorMode === 'count' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}`}>Ê¨°Êï∏ÈÅîÊ®ô</button>
                                                    <button onClick={() => updateConfig('distractorMode', 'time')} className={`px-4 py-1.5 rounded-lg font-bold text-xs transition-all ${config.distractorMode === 'time' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}`}>Ë®àÊôÇÊåëÊà∞</button>
                                                </div>
                                            </div>
                                            <div className="flex items-center justify-center py-2">
                                                <div className="flex items-center gap-8">
                                                    <span className="text-sm font-bold text-slate-400 uppercase">{config.distractorMode === 'count' ? 'ÁõÆÊ®ôÊ≠£Á¢∫È°åÊï∏' : 'ÊåëÊà∞ÁßíÊï∏'}</span>
                                                    <div className="flex items-center gap-5">
                                                        <button onClick={() => config.distractorMode === 'count' ? updateConfig('distractorTarget', Math.max(1, config.distractorTarget - 1)) : updateConfig('distractorDuration', Math.max(10, config.distractorDuration - 10))} className="w-12 h-12 rounded-2xl bg-white border border-slate-200 flex items-center justify-center text-slate-400 active:scale-90"><Icon name="minus" size={20} /></button>
                                                        <span className="text-3xl font-black min-w-[50px] text-center text-indigo-700">{config.distractorMode === 'count' ? config.distractorTarget : config.distractorDuration}</span>
                                                        <button onClick={() => config.distractorMode === 'count' ? updateConfig('distractorTarget', Math.min(50, config.distractorTarget + 1)) : updateConfig('distractorDuration', Math.min(120, config.distractorDuration + 10))} className="w-12 h-12 rounded-2xl bg-white border border-slate-200 flex items-center justify-center text-slate-400 active:scale-90"><Icon name="plus" size={20} /></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <button onClick={() => updateConfig('showIcons', !config.showIcons)} className={`w-full p-5 rounded-[2rem] border-2 transition-all flex items-center justify-between ${config.showIcons ? 'bg-indigo-50/50 border-indigo-100 text-indigo-700' : 'bg-slate-50/50 border-slate-100 text-slate-400'}`}>
                                            <div className="flex items-center gap-3"><Icon name={config.showIcons ? "eye" : "eye-off"} size={22}/><span className="text-lg font-black">ÂúñÁâáËºîÂä©Ê®°Âºè</span></div>
                                            <div className={`w-12 h-6 rounded-full relative transition-colors ${config.showIcons ? 'bg-indigo-600' : 'bg-slate-300'}`}><div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${config.showIcons ? 'left-7' : 'left-1'}`}></div></div>
                                        </button>
                                    </div>
                                    <button onClick={startGame} className="w-full max-w-xl mx-auto block bg-slate-900 hover:bg-black text-white text-xl font-black py-6 rounded-[2.5rem] shadow-2xl transition-all active:scale-95 group">
                                        <div className="flex items-center justify-center gap-2">ÂïüÂãïË®ìÁ∑¥Â§ßËÖ¶ <Icon name="arrow-right" className="group-hover:translate-x-2 transition-transform" /></div>
                                    </button>
                                </div>
                            )}

                            {stage === STAGES.MEMORIZE && (
                                <div className="animate-in slide-in-from-right duration-500">
                                    <div className="text-center mb-8"><h3 className="text-3xl font-black text-slate-900 mb-2">Ë´ãË®ò‰Ωè‰ª•‰∏ãÁâ©ÂìÅ</h3><div className="inline-flex items-center gap-2 px-4 py-1.5 bg-slate-100 rounded-full text-slate-500 font-bold text-sm"><Icon name="package" size={16}/> Áï∂ÂâçÈ°ûÂà•Ôºö{currentSet.category}</div></div>
                                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-6 mb-12">
                                        {targets.map(item => (
                                            <div key={item.id} className="bg-white border-2 border-slate-100 rounded-[2.5rem] p-6 text-center shadow-sm flex flex-col items-center justify-center min-h-[180px]">
                                                {config.showIcons && <div className="text-6xl mb-4">{item.icon}</div>}
                                                <div className={`font-black text-slate-800 ${config.showIcons ? 'text-2xl' : 'text-4xl'}`}>{item.name}</div>
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={() => setStage(STAGES.DISTRACT)} className="w-full bg-indigo-600 text-white text-2xl font-black py-6 rounded-[2rem] shadow-xl">Ë®òÂ•Ω‰∫ÜÔºåÈÄ≤ÂÖ•„Äå‰ªªÂãôÂàáÊèõ„ÄçÊåëÊà∞</button>
                                </div>
                            )}

                            {stage === STAGES.DISTRACT && (
                                <div className="text-center animate-in fade-in duration-300">
                                    <div className="flex justify-center mb-12">
                                        <div className={`px-8 py-3 bg-white border-2 rounded-3xl text-2xl font-black shadow-sm ${config.distractorMode === 'count' ? 'border-amber-200 text-amber-600' : 'border-red-200 text-red-500'}`}>
                                            {config.distractorMode === 'count' ? `Â∑≤Á≠îÂ∞çÔºö${stats.distractorCorrect} / ${config.distractorTarget}` : `Ââ©È§òÊôÇÈñìÔºö${timerLeft} Áßí`}
                                        </div>
                                    </div>
                                    <h3 className="text-2xl font-black mb-8 text-slate-400 uppercase tracking-widest">ÊñáÂ≠óÂÖßÂÆπ Ëàá È°èËâ≤ ÊòØÂê¶‰∏ÄËá¥Ôºü</h3>
                                    <div className={`mb-12 py-24 bg-white rounded-[4rem] border-4 transition-all relative ${lastFeedback === 'correct' ? 'border-green-400 bg-green-50/30' : lastFeedback === 'wrong' ? 'border-red-400 bg-red-50/30 shake' : 'border-slate-50'}`}>
                                        <span className="text-[7.5rem] font-black tracking-widest" style={{ color: distractorTask.color }}>{distractorTask.word}</span>
                                        {lastFeedback === 'correct' && <div className="absolute top-10 right-10 text-green-500"><Icon name="check-circle-2" size={64} /></div>}
                                        {lastFeedback === 'wrong' && <div className="absolute top-10 right-10 text-red-500"><Icon name="x" size={64} /></div>}
                                    </div>
                                    <div className="grid grid-cols-2 gap-10 max-w-2xl mx-auto">
                                        <button disabled={lastFeedback !== null} onClick={() => handleDistractorAnswer(true)} className="bg-green-500 hover:bg-green-600 text-white py-10 rounded-[3rem] text-5xl font-black shadow-lg active:scale-95 disabled:opacity-50">ÊòØ</button>
                                        <button disabled={lastFeedback !== null} onClick={() => handleDistractorAnswer(false)} className="bg-red-500 hover:bg-red-600 text-white py-10 rounded-[3rem] text-5xl font-black shadow-lg active:scale-95 disabled:opacity-50">Âê¶</button>
                                    </div>
                                </div>
                            )}

                            {stage === STAGES.RECALL && (
                                <div className="animate-in fade-in duration-500 text-center">
                                    <h3 className="text-3xl font-black text-slate-900 mb-8">Âª∂ÈÅ≤ÂõûÊÜ∂ÊåëÊà∞ÔºöÂâõÊâçË®ò‰Ωè‰∫Ü‰ªÄÈ∫ºÔºü</h3>
                                    <div className="flex justify-center mb-10">
                                        <div className="px-10 py-4 bg-indigo-600 text-white rounded-[2rem] font-black text-3xl shadow-xl ring-8 ring-indigo-50">{selections.length} / {targets.length}</div>
                                    </div>
                                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-5 mb-12">
                                        {options.map(item => {
                                            const isSelected = selections.find(s => s.id === item.id);
                                            return (
                                                <button key={item.id} onClick={() => toggleSelection(item)} className={`relative p-6 rounded-[2.5rem] border-2 transition-all flex flex-col items-center justify-center ${isSelected ? 'border-indigo-500 bg-indigo-50/50 scale-95 shadow-inner' : 'border-slate-100 bg-white hover:border-slate-200 shadow-sm'} ${config.showIcons ? 'h-44' : 'h-32'}`}>
                                                    {config.showIcons && <div className="text-5xl mb-2">{item.icon}</div>}
                                                    <div className={`font-black text-slate-700 ${config.showIcons ? 'text-xl' : 'text-2xl'}`}>{item.name}</div>
                                                    {isSelected && <div className="absolute top-4 right-4 bg-indigo-500 text-white rounded-full p-1 shadow-md"><Icon name="check-circle-2" size={24} /></div>}
                                                </button>
                                            );
                                        })}
                                    </div>
                                    <button onClick={finishGame} disabled={selections.length < targets.length} className={`w-full py-6 rounded-[2.5rem] text-2xl font-black shadow-2xl ${selections.length < targets.length ? 'bg-slate-200 text-slate-400' : 'bg-slate-900 text-white'}`}>{selections.length < targets.length ? `ÈÇÑÂ∑Æ ${targets.length - selections.length} ÂÄãÁ≠îÊ°à` : 'ÂÆåÊàêË®ìÁ∑¥ÔºåÊü•ÁúãÂàÜÊûêÂ†±Âëä'}</button>
                                </div>
                            )}

                            {stage === STAGES.RESULT && (
                                <div className="animate-in zoom-in duration-500">
                                    <div className="text-center mb-10">
                                        <div className="inline-block p-4 bg-slate-50 border rounded-3xl text-indigo-600 mb-4 shadow-sm"><Icon name="file-text" size={40}/></div>
                                        <h3 className="text-4xl font-black text-slate-900">Ë®ìÁ∑¥Â†±Âëä</h3>
                                        <p className="text-slate-400 font-bold">{currentDisplay.date}</p>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                                        <div className="bg-white rounded-[3rem] p-10 border-2 border-slate-50 shadow-sm text-center">
                                            <p className="text-slate-400 font-black mb-2 uppercase text-sm">ÂõûÊÜ∂Ê∫ñÁ¢∫Áéá</p>
                                            <div className="text-[6rem] font-black text-slate-900 leading-none mb-6">{Math.round((currentDisplay.score / currentDisplay.targets.length) * 100)}<span className="text-2xl ml-1">%</span></div>
                                            <div className="flex justify-center gap-3">{currentDisplay.targets.map((t, idx) => (<div key={idx} className={`w-4 h-4 rounded-full ${currentDisplay.selections.some(s => s.id === t.id) ? 'bg-green-500' : 'bg-red-400'}`}></div>))}</div>
                                        </div>
                                        <div className="bg-indigo-600 rounded-[3rem] p-10 text-white shadow-xl space-y-5">
                                            <div className="flex justify-between border-b border-indigo-500/30 pb-2"><span>ÊåëÊà∞Ê®°Âºè</span><span className="font-bold">{currentDisplay.config.distractorMode === 'count' ? 'Ê¨°Êï∏ÈÅîÊ®ô' : 'Ë®àÊôÇÊåëÊà∞'}</span></div>
                                            <div className="flex justify-between border-b border-indigo-500/30 pb-2"><span>Ê≠£Á¢∫Áéá</span><span className="font-bold">{Math.round((currentDisplay.stats.distractorCorrect / currentDisplay.stats.distractorTotal) * 100 || 0)}%</span></div>
                                            <div className="flex justify-between border-b border-indigo-500/30 pb-2"><span>ÂèçÊáâÊôÇÈñì</span><span className="font-bold">{Math.round(currentDisplay.stats.reactionTimes.reduce((a,b)=>a+b,0)/currentDisplay.stats.reactionTimes.length || 0)} ms</span></div>
                                        </div>
                                    </div>
                                    <div className="bg-slate-50 rounded-[2.5rem] p-8 mb-10">
                                        <div className="font-black text-slate-800 mb-6 px-2">Ë®òÊÜ∂Áâ©‰ª∂Ê∏ÖÂñÆ</div>
                                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
                                            {currentDisplay.targets.map(t => (
                                                <div key={t.id} className="flex items-center gap-3 px-5 py-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                                                    <span className="text-3xl">{t.icon}</span>
                                                    <div className="flex-1 font-black text-slate-700 truncate">{t.name}</div>
                                                    {currentDisplay.selections.some(s => s.id === t.id) ? <Icon name="check-circle-2" className="text-green-500" /> : <Icon name="x" className="text-red-400" />}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="flex gap-4">
                                        <button onClick={() => { setViewingRecord(null); setStage(STAGES.START); }} className="flex-1 bg-slate-900 text-white py-6 rounded-3xl text-xl font-black shadow-xl active:scale-95">ÂõûÂà∞‰∏ªÁï´Èù¢</button>
                                        <button onClick={() => setStage(STAGES.HISTORY)} className="flex-1 bg-white border-2 border-slate-100 text-slate-600 py-6 rounded-3xl text-xl font-black shadow-md">Ê≠∑Âè≤ÊàêÁ∏æ</button>
                                    </div>
                                </div>
                            )}

                            {stage === STAGES.HISTORY && (
                                <div className="animate-in fade-in duration-400">
                                    <div className="flex justify-between items-center mb-10"><h3 className="text-3xl font-black text-slate-900">Ë®ìÁ∑¥Ê≠∑Âè≤Á¥ÄÈåÑ</h3><button onClick={() => setStage(STAGES.START)}><Icon name="x" size={36} className="text-slate-400"/></button></div>
                                    <div className="space-y-4 max-h-[500px] overflow-y-auto pr-3 custom-scrollbar">
                                        {practiceHistory.length === 0 ? <div className="text-center py-24 bg-slate-50 rounded-[3rem] border-2 border-dashed border-slate-200 text-slate-400 font-black">ÁõÆÂâçÂ∞öÁÑ°Êï∏Êìö</div> : 
                                            practiceHistory.map(record => (
                                                <button key={record.id} onClick={() => showHistoryRecord(record)} className="w-full bg-white border-2 border-slate-50 p-6 rounded-[2rem] flex justify-between items-center hover:border-indigo-300 transition-all text-left shadow-sm">
                                                    <div><div className="text-xs font-black text-slate-300 uppercase">{record.date}</div><div className="text-xl font-black text-slate-800">Ë®òÊÜ∂ {record.config.targetCount} È†ÖÊåëÊà∞</div></div>
                                                    <div className="flex items-center gap-6"><div className="text-right"><div className="text-4xl font-black text-indigo-600">{Math.round((record.stats.finalScore / record.config.targetCount) * 100)}%</div></div><Icon name="chevron-right" className="text-slate-200" size={28} /></div>
                                                </button>
                                            ))
                                        }
                                    </div>
                                    <button onClick={() => setStage(STAGES.START)} className="w-full mt-10 bg-slate-900 text-white py-6 rounded-[2rem] font-black text-xl">ÂõûÂà∞‰∏ªÈ†Å</button>
                                </div>
                            )}
                        </div>

                        {/* Footer info */}
                        <div className="bg-slate-50 p-6 border-t border-slate-100 flex flex-col items-center gap-4">
                            <div className="flex justify-center gap-6 text-slate-400 text-[10px] font-black uppercase tracking-widest">
                                <div className="flex items-center gap-1"><Icon name="home" size={12}/> Living</div>
                                <div className="flex items-center gap-1"><Icon name="brain" size={12}/> Memory</div>
                                <div className="flex items-center gap-1"><Icon name="eye" size={12}/> Cognitive</div>
                            </div>
                            <div className="text-slate-400 text-xs font-bold border-t border-slate-200 pt-4 w-full text-center">
                                Ë®≠Ë®àÔºö<a href="https://www.facebook.com/mpotkevin" target="_blank" rel="noopener noreferrer" className="text-indigo-600 hover:text-indigo-800 transition-colors underline decoration-indigo-200 underline-offset-4 decoration-2">ËÅ∑ËÉΩÊ≤ªÁôÇÂ∏´ - ÈÑ≠Âá±Êñá</a>
                            </div>
                        </div>

                        {/* È°åÂ∫´ÂΩàÁ™ó */}
                        {showPool && (
                            <div className="absolute inset-0 z-50 bg-slate-900/80 backdrop-blur-xl p-4 flex items-center justify-center">
                                <div className="bg-white w-full max-h-[92%] rounded-[3.5rem] shadow-2xl overflow-hidden flex flex-col">
                                    <div className="p-8 bg-slate-50 border-b flex justify-between items-center">
                                        <div className="flex items-center gap-4"><div className="p-3 bg-white rounded-2xl text-indigo-600"><Icon name="package" size={28} /></div><div><h4 className="text-2xl font-black">Ë®ìÁ∑¥È°åÂ∫´ÁÆ°ÁêÜ</h4></div></div>
                                        <button onClick={() => setShowPool(false)} className="text-slate-400"><Icon name="x" size={32} /></button>
                                    </div>
                                    <div className="p-8 bg-white border-b">
                                        <form onSubmit={handleAddNewItem} className="flex gap-4">
                                            <input type="text" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} placeholder="‰æãÂ¶ÇÔºöÊîæÂ§ßÈè°..." className="flex-1 p-4 border-2 border-slate-50 rounded-2xl font-bold bg-slate-50/50 outline-none focus:border-indigo-400" />
                                            <select value={newItem.category} onChange={e => setNewItem({...newItem, category: e.target.value})} className="p-4 border-2 border-slate-50 rounded-2xl font-bold bg-slate-50/50 text-slate-600">
                                                {wordLibrary.map(cat => <option key={cat.category} value={cat.category}>{cat.category}</option>)}
                                            </select>
                                            <button type="submit" className="bg-slate-900 text-white px-8 rounded-2xl font-black">Êñ∞Â¢û</button>
                                        </form>
                                    </div>
                                    <div className="p-8 overflow-y-auto space-y-12 bg-slate-50/20 custom-scrollbar">
                                        {wordLibrary.map(set => (
                                            <div key={set.category}>
                                                <h5 className="font-black text-slate-900 mb-6 flex items-center gap-3 text-xl"><div className="w-2.5 h-6 bg-indigo-500 rounded-full"></div>{set.category}</h5>
                                                <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4">
                                                    {set.items.map(item => (
                                                        <div key={item.id} className="group relative p-5 bg-white rounded-3xl text-center border border-slate-100 flex flex-col items-center">
                                                            <button onClick={() => handleDeleteItem(set.category, item.id)} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-2 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="trash-2" size={14} /></button>
                                                            <div className="text-4xl mb-2">{typeof item.icon === 'string' ? item.icon : 'üì¶'}</div>
                                                            <div className="text-xs font-black text-slate-600 truncate w-full">{item.name}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
